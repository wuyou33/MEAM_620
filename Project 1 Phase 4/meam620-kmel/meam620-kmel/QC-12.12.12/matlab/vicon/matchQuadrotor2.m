%Copyright KMel Robotics 2012. Must read KMEL_LICENSE.pdf for terms and conditions before use.
function [BodyGood,World] = matchQuadrotor2(quadnum,vdata,viconid)

persistent Body

if(isempty(Body))
    
    Body{1} = [0 0 0;...
        7.10543e-015 -7.10543e-015 -95.3585;...
        7.10543e-015 49.7878 -130.718;...
        106.766 -56.7154 -119.766;...
        90.4211 54.1052 -171.622]';
    
    % Body{2} = [-91.1561 9.91259 -14.1389;...
    % -4.6069 20.401 21.0237;...
    % 18.4056 83.8478 -13.6049;...
    % 53.5537 -18.4072 20.5472;...
    % 23.8037 -95.7542 -13.8271]';
    
    Body{2} = [50.4152 -26.4555 17.9291;...
        -88.8318 18.9241 -13.6718;...
        -2.68162 19.2027 23.7995;...
        16.4049 -94.5499 -24.892;...
        24.6933 82.8787 -3.16486]';
    
    % this is the old 6 marker model
    % Body{11} = [-13.2132 100.316 -47.6731;...
    % 41.5329 -21.3787 -46.8294;...
    % 74.7072 -29.8797 -46.1695;...
    % -18.1941 -35.9582 -13.9166;...
    % -59.0144 -57.5668 70.1278;...
    % -25.8184 44.4671 84.4608]';
    
    
    Body{11} = [-117.346 -8.06174 -6.04038;...
        -1.53775 -43.8166 27.6408;...
        -22.1789 91.4266 -7.2163;...
        53.5173 -18.6318 -7.00836;...
        87.5452 -20.9165 -7.3758]';
    
    %this is for the old symmetric model
    % Body{13} = [-69.8348 13.701 -13.7767;...
    % -9.68816 -7.07114 20.7206;...
    % 36.6285 -20.2929 20.7456;...
    % -5.8077 -107.154 -14.763;...
    % 48.7021 120.817 -12.9267]';
    
    % Body{13} = [19.4018 -107.676 -13.5644;...
    %         -8.04546 5.1243 19.8073;...
    %         -70.054 13.0467 -13.029;...
    %         40.093 3.33765 20.8284;...
    %         18.6046 86.167 -14.0423]';
    
    Body{13} = [-48.9978 11.4938 21.6332;...
        -13.5349 -0.816907 21.0714;...
        -38.2923 -100.36 -15.3188;...
        112.336 -1.08464 -14.6589;...
        -11.5115 90.7679 -12.7269]';
    
    
    Body{16} = [-77.3797 2.59788 -13.3442;...
        18.6471 132.622 -13.9169;...
        -6.79026 9.71585 21.2497;...
        48.2105 -31.5905 19.5854;...
        17.3123 -113.345 -13.574]';
    
    
    Body{17} = [-0.126929 23.4373 20.9557;...
        24.8015 91.8823 -11.7323;...
        -104.124 19.8656 -13.5359;...
        20.0445 -116.849 -14.7348;...
        59.4047 -18.3363 19.0473]';
    
    %
    % Body{17} = [-93.6936 15.0709 -12.9673;...
    %     -7.74413 -104.783 -16.7844;...
    %     -23.8385 -2.96106 20.6759;...
    %     11.4303 61.2711 23.1917;...
    %     113.846 31.4023 -14.1158]';
    %
    % Body{17} = [20.3604 -115.222 -19.4763;...
    %     60.8784 -17.6913 19.8676;...
    %       0.0913681 22.8546 21.6668;...
    %       22.8006 92.1891 -9.27095;...
    %       -104.131 17.8694 -12.7872]';
    %
    
    
    %     Body{24} = [42.3809 6.67116 -2.16984;...
    %         0.377389 31.4912 1.85858;...
    %         0.257708 -37.4091 0.349137;...
    %         -43.016 -0.753237 -0.0378745]';
    
    Body{24} = [0.182354000000000 -37.857500000000002   1.432710000000000;...
        42.478900000000003   6.879970000000000  -2.800850000000000;...
        -43.309100000000001  -0.644935000000000   0.584230000000000;...
        0.647851000000000  31.622399999999999   0.783907000000000]';
    
    Body{25} = [-245.054 28.9044 1.5902;...
        126.106 4.8926 -1.01481;...
        188.84 -1.36417 -1.58735;...
        -22.7795 170.405 -2.32152;...
        -47.1118 -202.838 3.33347]';
    
    
    Body{26} = [105.848 6.83044 -8.40328;...
        21.416 59.1275 5.34956;...
        1.7067 -53.3367 5.02146;...
        -45.3843 -20.7208 4.89297;...
        -83.586 8.09953 -6.8607]';
    
    %this is for the nano it needs to be rotated
    %     Body{100} = [  -52.6431   19.2037   -0.2268;...
    %   -36.4835  -15.3177    0.6924;...
    %     7.0402   50.3040   -0.6124;...
    %    19.0716  -54.3972    0.2100;...
    %    63.0148    0.2072   -0.0632]';
    
    %     psi = -45*pi/180;
    %      Body{100} =  [cos(psi),-sin(psi),0;...
    %          sin(psi),cos(psi),0;...
    %          0,0,1]*([50,10,0;...
    %         85,25,0;...
    %         20,70,0;...
    %         125,80,0;...
    %         70,125,0]'-5.3/2*25.4*[1;1;0]*ones(1,5));
    
    Body{100} = [-52.7643  -28.2843         0;...
        -17.4090  -42.4264         0;...
        -31.5511   35.3553         0;...
        49.7662  -31.8198         0;...
        42.6951   38.8909         0]';
    
    Body{101} =    [-1.4139  -39.5117    0.1191;...
        -42.2730   -1.2566    0.0183;...
        -2.6424   41.6625    0.0126;...
        46.3293   -0.8942   -0.1499]';
    
    Body{102} = [-39.7524 -1.24045 0.417258;...
        -2.33466 41.5799 0.822397;...
        -1.95939 -39.3104 -0.60384;...
        44.0465 -1.02905 -0.635815]';
    
    Body{103} = [-39.1652 3.18049 0.455564;...
        -1.86095 41.2381 1.02957;...
        41.492 4.04927 -1.0634;...
        -0.465831 -48.4678 -0.421733]';
    
    Body{104} =[0.407898 43.446 0.589609;...
        -41.5348 -0.103966 1.67642;...
        2.87469 -45.6694 -1.07154;...
        38.2522 2.32737 -1.19449]';
    
    Body{105} = [40.825 0.60952 -2.06962;...
        4.919 -43.4865 -0.795627;...
        -45.4536 -4.35184 2.49373;...
        -0.290416 47.2288 0.371522]';
    
    Body{106} = [45.9808 -1.84071 -1.46092;...
        -6.02625 -48.6996 0.178663;...
        -43.077 6.41335 1.82175;...
        3.12242 44.1269 -0.539492]';
    
    Body{107} = [2.14968 -50.542 -0.742666;...
        -45.7518 -0.0932312 -0.182953;...
        -0.0502338 48.6747 0.423899;...
        43.6524 1.96048 0.50172]';
    
    Body{108} = [-47.6125 -1.7711 1.60258;...
        -2.12633 -45.0701 0.719093;...
        -0.468861 50.2663 -1.03117;...
        50.2077 -3.42509 -1.29051]';
    
    Body{109} = [-47.8675 1.74044 2.62309;...
        4.09786 38.7624 -0.887652;...
        40.758 0.605 -2.10855;...
        3.01167 -41.1078 0.373108]';
    
    Body{110} = [-2.45275 38.9306 0.353019;...
        -44.9082 0.875561 1.33934;...
        -2.10768 -40.7842 0.180696;...
        49.4686 0.978024 -1.87306]';
    
    Body{111} = [-47.3834 -5.10355 1.78043;...
        0.730694 49.0562 -1.03563;...
        6.02075 -43.9569 0.452755;...
        40.6319 0.00424194 -1.19755]';
    
    Body{112} = [-47.6845 2.40131 2.18725;...
        3.27272 39.398 -0.177116;...
        40.9993 2.07617 -2.00777;...
        3.41256 -43.8755 -0.00235748]';
    
    Body{113} = [-44.64 -1.8295 2.33926;...
        -0.974184 47.9285 0.486027;...
        39.0851 3.9617 -1.63343;...
        6.52915 -50.0607 -1.19185]';
    
    Body{114} = [-47.8318 -1.29145 -0.898721;...
        3.63148 50.2487 -0.978444;...
        3.43796 -48.0267 0.818355;...
        40.7623 -0.93055 1.05881]';
    
    Body{115} = [-43.2788 -7.34421 0.536304;...
        1.88286 47.8897 0.434808;...
        37.319 -2.83518 -0.767143;...
        4.07692 -37.7103 -0.203969]';
    
    Body{116} = [-43.6453 -2.50263 2.06843;...
        -0.745921 47.4738 0.0688143;...
        7.87645 -49.8164 -0.948426;...
        36.5148 4.84518 -1.18882]';
    
    Body{117} = [-46.7695 -5.93149 2.39946;...
        0.416878 50.5473 -0.065578;...
        37.9362 2.77075 -1.58593;...
        8.41639 -47.3866 -0.747951]';
    
    Body{119} = [-42.8958 0.17638 1.37653;...
        -3.03664 34.7078 0.708501;...
        45.5472 4.19524 -1.97027;...
        0.38518 -39.0794 -0.114753]';
    
    Body{120} = [5.22485 45.2615 0.104537;...
        -43.1133 1.02006 1.52768;...
        35.7212 -3.31838 -1.25621;...
        2.16729 -42.9632 -0.376004]';
    
    Body{121} = [-45.4193 9.18227 2.01143;...
        10.475 34.513 -0.0119076;...
        37.2878 -3.69243 -1.60309;...
        -2.34359 -40.0029 -0.396437]';
    
    Body{122} = [-39.3997 5.58728 -5.17763;...
        -8.24484 -38.1348 -3.3631;...
        43.5826 -8.69592 5.18658;...
        4.06201 41.2434 3.35415]';
    
    Body{123} = [-35.6407 0.279266 0.93295;...
        -5.60519 37.0448 0.565569;...
        1.27971 -43.9246 -0.163438;...
        39.9661 6.60056 -1.33508]';
    
    Body{124} = [-49.4932 5.00397 -0.395255;...
        7.48123 39.3172 -0.91383;...
        -2.25884 -35.5323 0.363468;...
        44.2708 -8.78881 0.945617]';
    
    
    Body{201} = [104.429 16.4588 -0.846344;...
        -91.1189 20.6404 2.69625;...
        -5.11346 -67.7822 1.67025;...
        -7.44047 -118.97 -1.31378;...
        -0.756199 149.653 -2.20638]';
    
    %this is the keyboard
    Body{401} = [-53.1101 423.288 -13.804;...
        47.4015 205.915 8.61326;...
        71.5598 -275.123 14.4692;...
        -65.8512 -354.08 -9.27846]';
    
    %this is the floor2
    
    
    
    Body{402} = 1.0e+03 *[3.034500,   1.27533,   0.00735301;...
        1.825700000000000,  -1.165130000000000,   0.002270520000000;...
        -0.590785000000000,  -1.308360000000000,  -0.005279090000000;...
        -4.269420000000000,   1.198170000000000,  -0.004344440000000]';
    
    
    %this is kquad301
    % Body{301} = [-121.564 -6.24302 3.15286;...
    %     23.3059 124.405 1.73441;...
    %     16.9631 -110.014 0.469197;...
    %     81.2954 -8.14813 -5.35647]';
    
    %these are the NDSquads
    % Body{501} =  [86.5441  -19.3909    2.6436;...
    %    14.5964  108.7630    3.3806;...
    %   -74.6698    8.2612   -3.2391;...
    %   -26.4707  -97.6337   -2.7851]';
    
    Body{501} = [   95.3222    9.8378   -0.5157;...
        0.9768   99.3190   -0.4498;...
        -102.8680    1.4165   -0.2401;...
        6.5693 -110.5730    1.2056]';
    
    Body{503} = [ -100.7030   -7.6578   -0.6893;...
        -13.9999  115.1630   -0.3947;...
        3.9905 -107.6150    0.6135;...
        110.7130    0.1091    0.4704]';
    
    Body{504} = [  -87.4697    1.1752    0.1729;...
        -3.4871 -116.2380    0.1854;...
        -8.4953  108.9090   -0.3907;...
        99.4522    6.1539    0.0324]';
    
    Body{505} = [   95.3267    2.7974   -0.0394;...
        -8.3627  108.4560   -0.0630;...
        -78.4672    3.2706   -0.0484;...
        -8.4969 -114.5240    0.1508]';
    
    Body{506} = [   74.2120   18.0511    0.3056;...
        -1.6658   81.8497   -0.3390;...
        -88.6653    6.0551   -0.4470;...
        16.1190 -105.9560    0.4804]';
    
    Body{507} = [   -11.1025  108.0000    1.1218;...
        102.5900   10.3083   -0.0979;...
        5.6433 -115.2680   -0.2829;...
        -97.1312   -3.0406   -0.7410]';
    
    %     Body{508} = [    4.7017   77.7481   -0.5875;...
    %         -87.2698    8.2502   -0.5374;...
    %         7.2312  -94.8786   -0.3073;...
    %         75.3369    8.8803    1.4322]';
    %
    Body{508} = [   74.8441    9.5273   -0.1151;...
        6.0063  -94.5357    0.6322;...
        -88.0236    6.1235    1.4256;...
        7.1731   78.8849   -1.9426]';
    
    Body{509} = [   86.7283   10.6037    0.0562;...
        -14.5278   95.4512   -0.4272;...
        -75.7731   -3.8325    0.3580;...
        3.5726 -102.2220    0.0129]';
    
    Body{510} = [  -92.1584   -3.7652    0.1573;...
        -9.0526 -107.5890   -0.0156;...
        -7.9475  114.7980    0.4080;...
        109.1580   -3.4437   -0.5496]';
    
    Body{512} = [86.3683   14.4515   -0.2477;...
        -0.6372   91.8261    0.3194;...
        -99.8183    0.9147   -0.0734;...
        14.0871 -107.1920    0.0017]';
    
    Body{513} = [74.8124   19.7551    0.7521;...
        0.7018   80.9092   -0.5080;...
        -96.4168    3.8774   -0.7238;...
        20.9025 -104.5420    0.4796]';
    
    Body{514} = [85.0551    8.8240    0.9505;...
        4.4492   91.0045   -0.7308;...
        -90.9515    8.4647   -0.6312;...
        1.4472 -108.2930    0.4115]';
    
    Body{515} = [72.4528   21.2200    0.6027;...
        -5.7895   81.9400    0.3796;...
        -80.0934    1.7686   -0.5766;...
        13.4301 -104.9290   -0.4057]';
    
    Body{516} = [-85.5393    3.5890   -0.1969;...
        0.0082 -111.5010    0.5644;...
        91.3883    7.7716   -0.1540;...
        -5.8571  100.1410   -0.2135]';
    
    Body{517} = [  104.0220  -13.6160    1.1960;...
        -4.6261  112.0150   -0.9462;...
        -81.4409    0.0870   -0.2163;...
        -17.9549  -98.4857   -0.0335]';
    
    Body{518} = [   93.8074    6.4342    0.5902;...
        -16.5607  100.8880    0.4248;...
        -77.0228   -9.4889    0.1053;...
        -0.2239  -97.8329   -1.1202]';
    
    Body{520} = [  107.3170    9.5293    0.8953;...
        -24.3148  108.5420    0.6186;...
        -88.1072  -18.6611   -0.4630;...
        5.1049  -99.4097   -1.0509]';
    
    Body{521} = [  106.2100    0.5344    0.1958;...
        -14.1156  113.2740    0.7201;...
        -81.0907   -3.8181   -0.6735;...
        -11.0032 -109.9900   -0.2424]';
    
    Body{522} = [   -9.2082  100.1030   -0.4519;...
        88.0136    7.5924   -0.2081;...
        -75.5127    4.7617   -0.2863;...
        -3.2927 -112.4570    0.9464]';
    
    Body{523} = [-8.9446 -110.6080    1.0291;...
        115.6850    2.8971   -0.8668;...
        -0.5414   92.6361   -0.9718;...
        -106.1990   15.0745    0.8095]';
    
    Body{524} = [77.6231    4.4968   -0.2773;...
        10.8349  101.4090    0.4534;...
        -87.5517   12.3093    0.2617;...
        -0.9063 -118.2150   -0.4377]';
    
    Body{601} =[  183.5890   -0.5640    2.5771;...
        4.7780  146.3040   -5.0133;...
        -174.3610   19.7377   -2.7149;...
        -14.0053 -165.4780    5.1511]';
    
    Body{702} = [   50.1017    4.7311    0.1666;...
        3.0047   50.6377   -0.5575;...
        -62.4043   -2.9554    0.1972;...
        9.2979  -52.4134    0.1937]';
    
    Body{703} = [    3.4456   59.7363   -0.3962;...
        -60.9658   -3.8070   -0.2754;...
        55.0681   -5.5856   -0.0101;...
        2.4522  -50.3437    0.6817]';
    
    Body{704} = [     1.5895   58.9965   -0.6338; ...
                     -56.5719   -1.2088    0.0071; ...
                      -3.7218  -50.0042    0.8298; ...
                       58.7042   -7.7835   -0.2031]';
    
end


BodyGood = [];
World = [];

cnt=0;
numpoints = size(vdata.subjects(viconid).markers,1);

for i=1:numpoints
    if(vdata.subjects(viconid).markers(i).visible)
        %this means the point is being seen
        cnt = cnt+1;
        BodyGood(:,cnt) = Body{quadnum}(:,i);
        World(:,cnt) = vdata(end).subjects(viconid).markers(i).xyz';
    end
end

